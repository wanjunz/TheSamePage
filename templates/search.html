{% extends "layout.html" %}

{% block title %}
Search
{% endblock %}

{% block main %}

<div class="container mt-4">

    <h1>Search Books</h1>

    <input autocomplete="off"
           autofocus
           placeholder="Search for a book title..."
           type="text"
           class="form-control mb-3">

    <!-- RESULTS GO HERE -->
    <ul id="results" class="list-unstyled mt-3"></ul>

</div>

<!-- Javascript to handle the backend of searching-->
<script>
    let input = document.querySelector("input");
    let results = document.getElementById("results");

    let lastQuery = "";

    input.addEventListener("input", async function () {
    
    // .trim() removes whitespace from both ends of the query string
    let q = input.value.trim();
    lastQuery = q;

    // If empty: clear results immediately and do not fetch
    if (q === "") {
        results.innerHTML = "";
        return;
    }

    let response = await fetch("/api/search?q=" + q);
    let books = await response.json();

    // If the input changed while async fetch was running, ignore these results
    // Since async function takes time to run, the user may have typed more characters. Only return search results if the query is still the same. So when the user has paused in their typing
    if (q !== lastQuery) return;

    function clean(str) {
        return str.toLowerCase().replace(/[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]/g, '');
    }

    let clean_query = clean(q).split(" ");

    let html = "";
    // Loop through the books returned from API and retrieve the titles, authors, and covers 
    for (let b of books) {
        // Used to check if any query words are in the title
        var titleQueryCheck = true;

        // Retrieve info about the books
        let title = b.title.replace("<", "&lt;").replace(">", "&gt;");
        let authors = b.authors.join(", ") || "Unknown";
        let img = b.thumbnail ? `<img src="${b.thumbnail}" width="60">` : "";

        // Loop through each word searched in teh query. If any of the words are in the title, then display this book.
        // This is needed because Google Books API searches the subtitles too.
        console.log("q: ", q);
        let clean_title = clean(title);
        
        for (let word of clean_query) {
            console.log("word: ", word);
            if (!clean_title.includes(word)) {
                titleQueryCheck = false;
                console.log("check: ", titleQueryCheck);
                console.log("word: ", word);
                console.log("title: ", title);
                break;
            }
        }
        if (titleQueryCheck) {
            html += `
            <li class="d-flex gap-3 align-items-start mb-3">
                <!-- POST form sends user to forum.html -->
                <div>
                    <form action="/forum" method="post">
                        <input type="hidden" name="title" value="${title}">
                        <input type = "hidden" name="authors" value="${authors}">
                        <input type="hidden" name="thumbnail" value="${b.thumbnail || ''}">
                        <button class="btn btn-primary" id = "find-forum">Find Forum</button>
                    </form>
                </div>
                ${img}
                <div>
                    <strong>${title}</strong><br>
                    <small>${authors}</small>
                </div>
            </li>`;

        }
        
    }

        results.innerHTML = html;
    });
</script>

{% endblock %}
