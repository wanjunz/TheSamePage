{% extends "layout.html" %}

{% block title %}
    Forum
{% endblock %}

{% block main %}
    <h1>Forum for <i>{{ title }}</i></h1>
    <p>Author(s): {{ authors }}</p>
    <div class = "mb-3">
        <img src="{{thumbnail}} " width="100" alt="Book Cover">
    </div>
    <!-- submit comment for overall forum -->
    <form action = "/comment" method ="post">
        <div class = "type-comment">
            <textarea name = "comment" placeholder = "type comment here"></textarea>
        </div>
        <div class = "mb-3">
            <!-- Values needed to display comment-->
            Currently reading page
            <input name = "page" id = page type = "number" min="0" max = {{pageCount}} oninput="validity.valid||(value='');">
            out of {{pageCount}} total pages (if applicable)
            <input name = "volumeID" type = "hidden" value = '{{forumID}}'> 
        </div>
        <div class = "mb-3">
            <button type = submit class = "reply-button">Upload Comment</button>
        </div>
    </form>
    <!-- Filter comments based on percentage read -->
    <form method="get" action="/forum">
        <input type="hidden" name="volumeID" value="{{ forum_id }}">

        <label for="page_filter"><strong>Filter comments by Page Number:</strong></label>
        <div class="input-group mb-2" style="max-width: 300px;">
            <input type="number" min="0" max="{{ pageCount }}" name="page_filter" id="page_filter"
                class="form-control" placeholder="Enter page number">
            <span class="input-group-text">/ {{ pageCount }}</span>
        </div>

        <button class="btn btn-primary mt-1" type="submit">Apply Filter</button>
    </form>

    {% if filter_percent %}
        <p class="mt-2 text-muted">
            Showing comments for reading progress â‰¤ <strong>{{ filter_percent }}%</strong>
        </p>
    {% endif %}

    <!-- display existing comments -->
    <!-- structure for comments is a list of these lists comment[0][username, text, parent_id, date, forum_id, percent]-->
    {% for comment in comments %}
        <div class = comment-box>
            <div class = comment-header>
                <div class="comment-username">
                    {{comment[0][0]}}
                </div>
                <div class="comment-right">
                    <span class="comment-percent">Percent read: {{comment[0][5]}}%</span>
                    <span class="comment-date">{{comment[0][3]}}</span>
                </div>
            </div>
            
            <div class = "comment-text">
                {{comment[0][1]}}
            </div>
            {% if comment[1] is not none %}
                <div class = "comment-reply">
                    (Reply to: {{comment[1]}})
                </div>
            {% endif %}
            <!-- Reply to a specific comment-->
            <p>
                
                <button class="reply-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{comment[0][6]}}" aria-expanded="false" aria-controls="collapse-{{comment[0][6]}}">
                  Reply
                </button>
            </p>
                <div class="collapse" id="collapse-{{comment[0][6]}}">
                    <div class="reply-card card-body">
                        <!-- reply to specific comment -->
                        <form action = "/comment" method ="post">
                            <div class = "mb-3">
                                <textarea name = "comment" placeholder = 'reply to {{comment[0][0]}} '></textarea>
                            </div>
                            <div class = "mb-3">
                                <input name = "parent_id" type = "hidden" value = '{{comment[0][6]}}'> 
                                <input name = "volumeID" type = "hidden" value = '{{comment[0][4]}}'> 
                            </div>
                            <div class = "mb-3">
                                <button type = submit class = "reply-button">Upload Reply</button>
                            </div>
                        </form>
                    </div>
              </div>
        </div>

        
    {% endfor %}
{% endblock %}
